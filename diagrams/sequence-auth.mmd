sequenceDiagram
    participant User as משתמש
    participant Frontend as Frontend<br/>(React)
    participant API as Backend API<br/>(Express)
    participant AuthService as Auth Service
    participant DB as MySQL<br/>(Sequelize)
    participant EmailService as Email Service
    participant SMTP as SMTP Server

    Note over User,SMTP: תהליך התחברות (Login)
    User->>Frontend: הזנת username/email + password
    Frontend->>API: POST /auth/login<br/>{username, password}
    API->>AuthService: findUserByUsernameOrEmail()
    AuthService->>DB: SELECT user WHERE username/email
    DB-->>AuthService: User data
    AuthService->>AuthService: bcrypt.compare(password)
    alt Password correct
        AuthService->>DB: Load permissions, skills, images
        DB-->>AuthService: User with relations
        AuthService->>API: User object
        API->>API: Create session<br/>(express-session)
        API->>DB: Store session<br/>(SequelizeStore)
        API-->>Frontend: 200 OK<br/>{user, session}
        Frontend->>Frontend: Update Redux store
        Frontend-->>User: Dashboard redirect
    else Password incorrect
        AuthService-->>API: Error
        API-->>Frontend: 401 Unauthorized
        Frontend-->>User: Error message
    end

    Note over User,SMTP: תהליך רישום (Register)
    User->>Frontend: מילוי טופס רישום
    Frontend->>API: POST /auth/register<br/>{username, email, password, ...}
    API->>API: Validation<br/>(express-validator)
    API->>AuthService: createUser()
    AuthService->>DB: INSERT user<br/>(with bcrypt hash)
    DB-->>AuthService: Created user
    AuthService->>API: Success
    API->>API: Create session
    API-->>Frontend: 201 Created<br/>{user, session}
    Frontend-->>User: Welcome / Dashboard

    Note over User,SMTP: תהליך איפוס סיסמה (Forgot Password)
    User->>Frontend: הזנת email
    Frontend->>API: POST /auth/forgot-password<br/>{email}
    API->>AuthService: findUserByUsernameOrEmail()
    AuthService->>DB: SELECT user WHERE email
    DB-->>AuthService: User
    AuthService->>AuthService: createToken()<br/>(crypto.randomBytes)
    AuthService->>DB: INSERT password_reset_token
    AuthService->>EmailService: sendEmailWithLinkReset()
    EmailService->>SMTP: Send email with reset link
    SMTP-->>EmailService: Email sent
    EmailService-->>AuthService: Success
    AuthService-->>API: Success
    API-->>Frontend: 200 OK<br/>{message}
    Frontend-->>User: Email sent confirmation

    User->>Frontend: Click reset link<br/>(from email)
    Frontend->>API: POST /auth/reset-password<br/>{token, password}
    API->>AuthService: checkIfActiveTokenExist(token)
    AuthService->>DB: SELECT token WHERE token AND not used
    DB-->>AuthService: Token
    alt Token valid
        AuthService->>DB: UPDATE user SET password<br/>(bcrypt hash)
        AuthService->>DB: UPDATE token SET used=true
        AuthService->>EmailService: sendEmail()<br/>Password reset successful
        EmailService->>SMTP: Send confirmation email
        AuthService-->>API: Success
        API-->>Frontend: 200 OK
        Frontend-->>User: Redirect to login
    else Token invalid/expired
        AuthService-->>API: Error
        API-->>Frontend: 400 Bad Request
        Frontend-->>User: Error message
    end

